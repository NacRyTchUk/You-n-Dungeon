unit TFieldClass;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Imaging.pngimage, Vcl.ExtCtrls,
  TCardClass, nicestuff;

// 14    110x145
// 145  606
// 41   463

type
  TFieldOfCards = array [0 .. FIELD_SIZE_X - 1, 0 .. FIELD_SIZE_Y - 1] of TCard;

type
  TField = class
  private
    Size: TPosition;
    PlayerCard: TPosition;
    FieldOfCards: TFieldOfCards;
    CardAnimState: array [0 .. CARD_ANIM_COUNT] of bool;
    CardAnimStage: array [0 .. CARD_ANIM_COUNT] of integer;
    CardAnimFrame: array [0 .. CARD_ANIM_COUNT] of integer;
    CardAnimIndex: array [0 .. CARD_ANIM_COUNT, 1 .. 2] of integer;
  public
    function GetFieldSize(): TPosition;
    function GetFieldOfCards(): TFieldOfCards;
    function IsCardAnimPlayed(): bool; overload;
    function IsCardAnimPlayed(AnimIndex: integer): bool; overload;

    procedure ToggleAnimOn(AnimIndex, x, y: integer);
    procedure UpdateAnim();
    procedure PlayAnim_SizeOut(x, y: integer);
    procedure PlayAnim_SizeIn(x, y: integer);

    Constructor Create();
    // Destructor  Destroy;
  end;

implementation

function TField.GetFieldSize;
begin
  GetFieldSize := Size;
end;

function TField.GetFieldOfCards(): TFieldOfCards;
begin
  GetFieldOfCards := FieldOfCards;
end;

Constructor TField.Create();
var
  i, j: integer;
begin

  for i := 0 to FIELD_SIZE_X - 1 do
    for j := 0 to FIELD_SIZE_Y - 1 do
    begin
      FieldOfCards[i, j] := TCard.Create(CTP(i, j));

    end;

end;

function TField.IsCardAnimPlayed(): bool;
begin
  IsCardAnimPlayed := CardAnimState[0];
end;

function TField.IsCardAnimPlayed(AnimIndex: integer): bool;
begin
  IsCardAnimPlayed := CardAnimState[AnimIndex];
end;

procedure TField.ToggleAnimOn(AnimIndex, x, y: integer);
begin
  if AnimIndex <= CARD_ANIM_COUNT then
  begin
    CardAnimIndex[AnimIndex, 1] := x;
    CardAnimIndex[AnimIndex, 2] := y;
    CardAnimState[AnimIndex] := true;
  end;

end;

procedure TField.UpdateAnim();
var
  i: integer;
begin
  if CardAnimState[1] then
    PlayAnim_SizeOut(CardAnimIndex[1, 1], CardAnimIndex[1, 2]);
  if CardAnimState[2] then
    PlayAnim_SizeIn(CardAnimIndex[2, 1], CardAnimIndex[2, 2]);
end;

procedure TField.PlayAnim_SizeOut(x, y: integer);
const
  OneStageStepsAmount = 5;
begin

  if not IsCardAnimPlayed(1) then
    exit;

  Inc(CardAnimStage[1]);

  if CardAnimStage[1] < OneStageStepsAmount then
    exit;

  CardAnimStage[1] := 0;
  Inc(CardAnimFrame[1]);

  FieldOfCards[x, y].ScaleAt((10 - CardAnimFrame[1]) / 10);

  if CardAnimFrame[1] >= 10 then
  begin
    CardAnimFrame[1] := 0;
    CardAnimState[1] := false;
    CardAnimStage[1] := 0;
  end;
end;

procedure TField.PlayAnim_SizeIn(x, y: integer);
const
  OneStageStepsAmount = 5;
begin

  if not IsCardAnimPlayed(2) then
    exit;

  Inc(CardAnimStage[2]);

  if CardAnimStage[2] < OneStageStepsAmount then
    exit;

  CardAnimStage[2] := 0;
  Inc(CardAnimFrame[2]);

  FieldOfCards[x, y].ScaleAt((CardAnimFrame[2]) / 10);

  if CardAnimFrame[2] >= 10 then
  begin
    CardAnimFrame[2] := 0;
    CardAnimState[2] := false;
    CardAnimStage[2] := 0;
  end;
end;

end.
